<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Single Variable Algebra Playground</title>
	<style>
	html {
		margin: 1.4vh;
		background-color: #ddd;
	}

	input[type="text"],
	textarea {
		min-width: 100%;
		max-width: 100%;
		font-style: Consolas;
	}

	textarea {
		min-height: 30vh;
	}
	</style>
</head>

<body>
	<h2>Single Variable Algebra Playground</h2>
	<p>
		<input type="checkbox" id="checkbox" onclick="checkbox()"> Use Turing machine standard text format (<a href="https://wiki.bbchallenge.org/wiki/Turing_machine#Standard_text_format">syntax</a>). Tape length: <input id="bandLength" onchange="translate_tm_to_sva()" min="1" max="450" step="1" type="number" value="50" disabled>
	</p>
	<p><input type="text" id="tm" onchange="translate_tm_to_sva()" value="1RB1LB_1LA0LC_1RZ1LD_1RD0RA" disabled /></p>
	<p>Single Variable Algebra (for convenience, f(x) = g(g(g(x))) equals f(x) = g^[3](x)):</p>
	<textarea id="sva" style="overflow-wrap: normal; overflow-x: scroll; white-space: pre"></textarea>
	<p>
		<a onclick="window.location.reload()" href="javascript:void(0);"><b>Calculate output &#9654;</b></a>
	</p>
	</p>
	<textarea id="output" disabled></textarea>
	<p><a href="https://github.com/772/single-variable-algebra-compiler">Git Repository</a></p>
	<script>
	function turing_machine_translate(currentState, write0, action0, newstate0, write1, action1, newstate1, ) {
		return ("+is" + currentState + "(x)*(is0(10*(x-" + currentState + "))*(" + newstate0 + "+" + action0 + "(x-" + currentState + "+0." + write0 + "))+is1(10*(x-" + currentState + "))*(" + newstate1 + "+" + action1 + "(x-" + currentState + "-0.1+0." + write1 + ")))");
	}

	function translate_tm_to_sva() {
		let tmString = document.getElementById("tm").value;
		let algebra = `decimals(x) = ` + Number(document.getElementById("bandLength").value) + `\n` + `abs(x) = (x^2)^(1/2)
         H(x) = (x+abs(x))/(2*x)
         tiny(x) = 10^(-decimals(x))
         ge0(x) = H(x+tiny(x)/10)
         lt1(x) = 1-ge0(x-1)
         is0(x) = ge0(x)*lt1(x)
         is1(x) = is0(x-1)
         is2(x) = is0(x-2)
         is3(x) = is0(x-3)
         is4(x) = is0(x-4)
         is5(x) = is0(x-5)
         is6(x) = is0(x-6)
         is7(x) = is0(x-7)
         is8(x) = is0(x-8)
         is9(x) = is0(x-9)
         floor1(x) = is1(x)+2*is2(x)+3*is3(x)+4*is4(x)+5*is5(x)+6*is6(x)+7*is7(x)+8*is8(x)+9*is9(x)
         right(x) = x*10-floor1(x*10)+floor1(x*10)*tiny(x)
         left(x) = right^[` + (Number(document.getElementById("bandLength").value) - 1) + `](x)
         tm(x) = is0(x)*x`;
		const blocks = tmString.split("_");
		blocks.forEach((block, index) => {
			const currentState = index + 1;
			const trans0 = block.substring(0, 3);
			const write0 = parseInt(trans0[0]);
			const action0 = trans0[1] == "L" ? "left" : "right";
			let newstate0 = trans0[2].charCodeAt(0) - 64;
			newstate0 = newstate0 == 26 ? 0 : newstate0;
			const trans1 = block.substring(3, 6);
			const write1 = parseInt(trans1[0]);
			const action1 = trans1[1] == "L" ? "left" : "right";
			let newstate1 = trans1[2].charCodeAt(0) - 64;
			newstate1 = newstate1 == 26 ? 0 : newstate1;
			algebra += turing_machine_translate(currentState, write0, action0, newstate0, write1, action1, newstate1, );
		});
		document.getElementById("sva").value = algebra + "\n" + `f(x) = tm^[10000](x)\n` + `f(1)`;
	}

	function checkbox() {
		let checked = document.getElementById("checkbox").checked;
		document.getElementById("tm").disabled = !checked;
		document.getElementById("bandLength").disabled = !checked;
		document.getElementById("sva").disabled = checked;
	}
	checkbox();
	window.addEventListener("DOMContentLoaded", (event) => {
		const textarea = document.getElementById("sva");
		const gespeicherterText = sessionStorage.getItem("textAreaInhalt");
		if(gespeicherterText) {
			textarea.value = gespeicherterText;
		}
		textarea.addEventListener("sva", function() {
			sessionStorage.setItem("textAreaInhalt", textarea.value);
		});
	});
	window.addEventListener("beforeunload", function() {
		const textarea = document.getElementById("sva");
		sessionStorage.setItem("textAreaInhalt", textarea.value);
	});
	</script>
<button id="loadWasmBtn">WASM laden</button>

<script type="module">
  let wasmInitialized = false;
  
  document.getElementById('loadWasmBtn').addEventListener('click', async () => {
    if (wasmInitialized) {
      console.log('WASM bereits geladen');
      return;
    }
    
    try {
      const { default: init } = await import('./wasm.js');
      await init();
      wasmInitialized = true;
      console.log('WASM erfolgreich geladen');
    } catch (error) {
      if (!error.message.startsWith(
        "Using exceptions for control flow, don't mind me. This isn't actually an error!"
      )) {
        console.error('Fehler beim Laden des WASM-Moduls:', error);
        throw error;
      }
    }
  });
</script>
</body>

</html>
